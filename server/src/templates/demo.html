<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async WebSearch Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-8">Async WebSearch Demo</h1>

        <details id="config-panel" open class="mb-6 bg-white p-4 rounded-lg shadow">
            <summary class="cursor-pointer text-lg font-semibold">Search Configuration</summary>
            <form id="config-form" class="mt-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Sources</label>
                    <div class="mt-2 space-y-2">
                        <label class="inline-flex items-center mr-4">
                            <input type="checkbox" name="sources" value="google" class="rounded">
                            <span class="ml-2">Google</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="checkbox" name="sources" value="wikipedia" class="rounded">
                            <span class="ml-2">Wikipedia</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="checkbox" name="sources" value="arxiv" class="rounded">
                            <span class="ml-2">ArXiv</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="checkbox" name="sources" value="newsapi" class="rounded">
                            <span class="ml-2">NewsAPI</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="checkbox" name="sources" value="github" class="rounded">
                            <span class="ml-2">GitHub</span>
                        </label>
                        <label class="inline-flex items-center mr-4">
                            <input type="checkbox" name="sources" value="pubmed" class="rounded">
                            <span class="ml-2">PubMed</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="max_results" class="block text-sm font-medium text-gray-700">Max Results</label>
                    <input type="number" id="max_results" name="max_results" min="1" max="10"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="max_preview_chars" class="block text-sm font-medium text-gray-700">Max Preview
                        Chars</label>
                    <input type="number" id="max_preview_chars" name="max_preview_chars" min="100"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label for="timeout" class="block text-sm font-medium text-gray-700">Timeout (seconds)</label>
                    <input type="number" id="timeout" name="timeout" step="0.1"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </form>
        </details>

        <form id="search-form" class="mb-6">
            <div class="flex">
                <input type="text" id="query" name="query" placeholder="Enter your search query"
                    class="flex-1 rounded-l-md border-gray-300 shadow-sm px-3 py-2" required>
                <button type="submit"
                    class="bg-blue-500 text-white px-4 py-2 rounded-r-md hover:bg-blue-600">Search</button>
            </div>
        </form>

        <div id="results" class="bg-white p-4 rounded-lg shadow"></div>
    </div>

    <script>
        const configKey = 'searchConfig';
        const collapsedKey = 'configCollapsed';

        function loadConfig() {
            const config = JSON.parse(localStorage.getItem(configKey)) || {
                sources: ['google'],
                max_results: 3,
                max_preview_chars: 1024,
                timeout: null
            };

            // Set sources
            document.querySelectorAll('input[name="sources"]').forEach(cb => {
                cb.checked = config.sources.includes(cb.value);
            });

            // Set other fields
            document.getElementById('max_results').value = config.max_results;
            document.getElementById('max_preview_chars').value = config.max_preview_chars;
            document.getElementById('timeout').value = config.timeout || '';

            return config;
        }

        function saveConfig() {
            const sources = Array.from(document.querySelectorAll('input[name="sources"]:checked')).map(cb => cb.value);
            const max_results = parseInt(document.getElementById('max_results').value) || 3;
            const max_preview_chars = parseInt(document.getElementById('max_preview_chars').value) || 1024;
            const timeout = document.getElementById('timeout').value ? parseFloat(document.getElementById('timeout').value) : null;

            const config = { sources, max_results, max_preview_chars, timeout };
            localStorage.setItem(configKey, JSON.stringify(config));
            return config;
        }

        function displayResults(results) {
            const div = document.getElementById('results');
            div.innerHTML = '';

            if (typeof results === 'string') {
                if (results) div.innerHTML = results
                else {
                    div.innerHTML = '<p class="text-gray-500">No results found.</p>';
                }
                return;
            }

            if (!Array.isArray(results)) {
                div.innerHTML = '<p class="text-red-500">Error: Invalid results format received from server</p>';
                console.error('Expected results to be an array, got:', results);
                return;
            }

            if (!results || results.length === 0) {
                div.innerHTML = '<p class="text-gray-500">No results found.</p>';
                return;
            }

            results.forEach(sourceResult => {
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'mb-4';

                const h3 = document.createElement('h3');
                h3.className = 'text-xl font-semibold mb-2';
                h3.textContent = sourceResult.source.charAt(0).toUpperCase() + sourceResult.source.slice(1);
                sourceDiv.appendChild(h3);

                if (sourceResult.results && sourceResult.results.length > 0) {
                    sourceResult.results.forEach(result => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'mb-3 p-3 bg-gray-50 rounded';

                        const title = document.createElement('h4');
                        title.className = 'font-medium text-blue-600';
                        title.textContent = result.title;
                        resultDiv.appendChild(title);

                        const snippet = document.createElement('p');
                        snippet.className = 'text-sm text-gray-700 mt-1';
                        snippet.textContent = result.preview;
                        resultDiv.appendChild(snippet);

                        if (result.url) {
                            const link = document.createElement('a');
                            link.href = result.url;
                            link.target = '_blank';
                            link.className = 'text-xs text-blue-500 hover:underline';
                            link.textContent = result.url;
                            resultDiv.appendChild(link);
                        }

                        sourceDiv.appendChild(resultDiv);
                    });
                } else {
                    const noResults = document.createElement('p');
                    noResults.className = 'text-gray-500';
                    noResults.textContent = 'No results from this source.';
                    sourceDiv.appendChild(noResults);
                }

                div.appendChild(sourceDiv);
            });
        }

        // Load initial config
        loadConfig();

        // Load collapsed state
        const collapsed = localStorage.getItem(collapsedKey) === 'true';
        document.getElementById('config-panel').open = !collapsed;

        // Save collapsed state on toggle
        document.getElementById('config-panel').addEventListener('toggle', function () {
            localStorage.setItem(collapsedKey, !this.open);
        });

        // Save config on change
        document.getElementById('config-form').addEventListener('change', saveConfig);
        document.getElementById('config-form').addEventListener('input', saveConfig);

        // Handle search
        document.getElementById('search-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const query = document.getElementById('query').value.trim();
            if (!query) return;

            const config = saveConfig();
            document.getElementById('results').innerHTML = '<p class="text-gray-500">Searching...</p>';

            const response = await fetch('/search', {
                method: 'POST',
                body: JSON.stringify({
                    query: query,
                    sources: config.sources,
                    max_results: config.max_results,
                    max_preview_chars: config.max_preview_chars,
                    timeout: config.timeout
                }),
                headers: {
                    'Content-Type': 'application/json'
                },
            }).then((res) => {
                if (res.ok) return res.json()
                throw new Error(`HTTP error! status: ${response.status}`);
            }).catch((err) => {
                document.getElementById('results').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            })

            displayResults(response.results);
        });
    </script>
</body>

</html>
